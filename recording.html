<!--
> Muaz Khan     - www.MuazKhan.com
> MIT License   - www.WebRTC-Experiment.com/licence
> Documentation - github.com/muaz-khan/RecordRTC
> and           - RecordRTC.org
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <title>RecordRTC</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/media.css">

    <script src="node_modules/recordrtc/RecordRTC.js"></script>
    <script src="assets/js/media.js"></script>
    
    <script src="https://unpkg.com/@mattiasbuelens/web-streams-polyfill/dist/polyfill.min.js"></script>
    <script src="https://www.webrtc-experiment.com/EBML.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="https://www.webrtc-experiment.com/DetectRTC.js"> </script>
</head>

<body>
    <main>
        <h2 class="header" style="margin: 0;">
            <select class="recording-media">
                <option value="with-sound" selected>With Sound</option>
                <option value="without-sound">Without Sound</option>
            </select>

            <div class="">
                <button id="btn-start-recording" style="display: inline-block; font-size: 15px;">Start</button>
                <button id="btn-pause-recording" style="display: none; font-size: 15px;">Pause</button>
            </div>

            <div class="hidden">
                <input type="checkbox" id="chk-fixSeeking" style="margin:0;width:auto;" title="Fix video seeking issues?">
                <label for="chk-fixSeeking" style="font-size: 15px;margin:0;width: auto;cursor: pointer;-webkit-user-select:none;user-select:none;" title="Fix video seeking issues?">Fix Seeking Issues?</label>
            </div>

            <select class="media-resolutions">
                <option value="default" selected>Default</option>
                <option value="1920x1080">1080p  </option>
                <option value="1280x720"> 720p   </option>
                <option value="640x480">  480p   </option>
                <option value="3840x2160">4K     </option>
            </select>

            <select class="media-framerates">
                <option value="default" selected>Default</option>
                <option value="5"> 5 fps</option>
                <option value="15">15 fps</option>
                <option value="24">24 fps</option>
                <option value="30">30 fps</option>
                <option value="60">60 fps</option>
            </select>

            <select class="media-bitrates">
                <option value="default" selected>Default</option>
                <option value="8589934592">1 GB bps     </option>
                <option value="838860800"> 100 MB bps   </option>
                <option value="8388608">   1 MB bps     </option>
                <option value="819200">    100 KB bps   </option>
                <option value="8192">      1 KB bps     </option>
                <option value="800">       100 Bytes bps</option>
            </select>

            <select class="media-container-format">
                <option selected>Default</option>
                <option>vp8        </option>
                <option>vp9        </option>
                <option>h264       </option>
                <option>mkv        </option>
                <option>opus       </option>
                <option>ogg        </option>
                <option>pcm        </option>
                <option>gif        </option>
                <option>whammy     </option>
                <option>WebAssembly</option>
            </select>
        </h2>

        <div style="text-align: center; display: none;">
            <button id="save-to-disk"> Download</button>
            <button id="upload-to-php">Upload  </button>
        </div>

        <div style="margin-top: 10px;" id="recording-player">
        </div>
    </main>

    <script>
        (function() {
            var params = {}
            var regex = /([^&=]+)=?([^&]*)/g

            function d(s) {
                return decodeURIComponent(s.replace(/\+/g, ' '))
            }

            var match, search = window.location.search

            while (match = regex.exec(search.substring(1))) {
                params[d(match[1])] = d(match[2]);

                if (d(match[2]) === 'true' || d(match[2]) === 'false') {
                    params[d(match[1])] = (d(match[2]) === 'true')
                }
            }

            window.params = params;
        })();

        function addStreamStopListener(stream, callback) {
            stream.addEventListener('ended', function() {
                callback();
                callback = function() {};
            }, false)

            stream.addEventListener('inactive', function() {
                callback();
                callback = function() {};
            }, false)

            stream.getTracks().forEach(function(track) {
                track.addEventListener('ended', function() {
                    callback();
                    callback = function() {};
                }, false)

                track.addEventListener('inactive', function() {
                    callback();
                    callback = function() {};
                }, false)
            })
        }
    </script>

    <script>
        var video = document.createElement('video')
        video.controls = false

        var media_element = getHTMLMediaElement(video, {
            title: 'Recording is inactive',
            buttons: ['full-screen'],
            showOnMouseEnter: false,
            width: 720,
        })

        media_element.id = 'media-element'

        document.getElementById('recording-player').appendChild(media_element)

        var media_element_container = document.createElement('section')

        media_element.media.muted = false
        media_element.media.autoplay = true
        media_element.media.playsinline = true
        media_element.media.id = 'media-element-media'
        media_element_container.id = 'media-element-container'

        media_element.media.parentNode.appendChild(media_element_container)
        media_element_container.appendChild(media_element.media)
        
        
        var recordingPlayer = media_element.media
        var recordingMedia = document.querySelector('.recording-media') // Sound/No sound selector
        var mediaContainerFormat = document.querySelector('.media-container-format')

        var mimeType = 'video/webm'
        var fileExtension = 'webm'
        var type = 'video'
        var recorderType
        var defaultWidth
        var defaultHeight

        var btnStart = document.querySelector('#btn-start-recording')

        window.onbeforeunload = function() {
            btnStart.disabled = false
            recordingMedia.disabled = false
            mediaContainerFormat.disabled = false
        };

        btnStart.onclick = function(event) {
            if (btnStart.innerHTML === 'Stop') {
                btnPause.style.display = 'none'
                btnStart.disabled = true
                btnStart.disableStateWaiting = true

                setTimeout(function() {
                    btnStart.disabled = false
                    btnStart.disableStateWaiting = false
                }, 2000)

                btnStart.innerHTML = 'Start'

                function stopStream() {
                    if (btnStart.stream && btnStart.stream.stop) {
                        btnStart.stream.stop()
                        btnStart.stream = null
                    }

                    if (btnStart.stream instanceof Array) {
                        btnStart.stream.forEach(function(stream) {
                            stream.stop()
                        })

                        btnStart.stream = null
                    }

                    videoBitsPerSecond = null
                    recordingPlayer.parentNode.parentNode.querySelector('h2').innerHTML = 'Recording stopped' +
                        '<br>Size: ' + bytesToSize(btnStart.recordRTC.getBlob().size)
                }

                if (btnStart.recordRTC) {
                    if (btnStart.recordRTC.length) {
                        btnStart.recordRTC[0].stopRecording(function(url) {
                            if (!btnStart.recordRTC[1]) {
                                btnStart.recordingEndedCallback(url)
                                stopStream()
                                saveToDiskOrOpenNewTab(btnStart.recordRTC[0])
                                return
                            }

                            btnStart.recordRTC[1].stopRecording(function(url) {
                                btnStart.recordingEndedCallback(url)
                                stopStream()
                            })
                        })
                    }
                    else {
                        btnStart.recordRTC.stopRecording(function(url) {
                            if (btnStart.blobs && btnStart.blobs.length) {
                                var blob = new File(
                                    btnStart.blobs,
                                    getFileName(fileExtension),
                                    {type: mimeType}
                                )
                                
                                btnStart.recordRTC.getBlob = function() {
                                    return blob
                                }

                                url = URL.createObjectURL(blob)
                            }

                            btnStart.recordingEndedCallback(url)
                            saveToDiskOrOpenNewTab(btnStart.recordRTC)
                            stopStream()
                        })
                    }
                }

                return
            }

            if (!event) return

            btnStart.disabled = true

            var commonConfig = {
                onMediaCaptured: function(stream) {
                    btnStart.stream = stream
                    if (btnStart.mediaCapturedCallback) {
                        btnStart.mediaCapturedCallback()
                    }

                    btnStart.innerHTML = 'Stop'
                    btnStart.disabled = false
                },

                onMediaStopped: function() {
                    btnStart.innerHTML = 'Start'

                    if (!btnStart.disableStateWaiting) {
                        btnStart.disabled = false
                    }
                },

                onMediaCapturingFailed: function(error) {
                    console.error('onMediaCapturingFailed:', error);

                    if (error.toString().indexOf('no audio or video tracks available') !== -1) {
                        alert('RecordRTC failed to start because there are no audio or video tracks available.');
                    }
                    
                    if (error.name === 'PermissionDeniedError' && DetectRTC.browser.name === 'Firefox') {
                        alert('Firefox requires version >= 52. Firefox also requires HTTPs.');
                    }

                    commonConfig.onMediaStopped()
                }
            };

            if (mediaContainerFormat.value === 'h264') {
                mimeType = 'video/webm\;codecs=h264';
                fileExtension = 'mp4';

                // video/mp4;codecs=avc1    
                if (isMimeTypeSupported('video/mpeg')) {
                    mimeType = 'video/mpeg';
                }
            }

            if (mediaContainerFormat.value === 'mkv' && isMimeTypeSupported('video/x-matroska;codecs=avc1')) {
                mimeType = 'video/x-matroska;codecs=avc1';
                fileExtension = 'mkv';
            }

            if (mediaContainerFormat.value === 'vp8' && isMimeTypeSupported('video/webm\;codecs=vp8')) {
                mimeType = 'video/webm\;codecs=vp8';
                fileExtension = 'webm';
                recorderType = null;
                type = 'video';
            }

            if (mediaContainerFormat.value === 'vp9' && isMimeTypeSupported('video/webm\;codecs=vp9')) {
                mimeType = 'video/webm\;codecs=vp9';
                fileExtension = 'webm';
                recorderType = null;
                type = 'video';
            }

            if (mediaContainerFormat.value === 'pcm') {
                mimeType = 'audio/wav';
                fileExtension = 'wav';
                recorderType = StereoAudioRecorder;
                type = 'audio';
            }

            if (mediaContainerFormat.value === 'opus' || mediaContainerFormat.value === 'ogg') {
                if (isMimeTypeSupported('audio/webm')) {
                    mimeType = 'audio/webm';
                    fileExtension = 'webm'; // webm
                }

                if (isMimeTypeSupported('audio/ogg')) {
                    mimeType = 'audio/ogg; codecs=opus';
                    fileExtension = 'ogg'; // ogg
                }

                recorderType = null;
                type = 'audio';
            }

            if (mediaContainerFormat.value === 'whammy') {
                mimeType = 'video/webm';
                fileExtension = 'webm';
                recorderType = WhammyRecorder;
                type = 'video';
            }

            if (mediaContainerFormat.value === 'WebAssembly') {
                mimeType = 'video/webm';
                fileExtension = 'webm';
                recorderType = WebAssemblyRecorder;
                type = 'video';
            }

            if (mediaContainerFormat.value === 'gif') {
                mimeType = 'image/gif';
                fileExtension = 'gif';
                recorderType = GifRecorder;
                type = 'gif';
            }

            if (mediaContainerFormat.value === 'default') {
                mimeType = 'video/webm';
                fileExtension = 'webm';
                recorderType = null;
                type = 'video';
            }

            if (recordingMedia.value === 'without-sound') {
                captureScreen(commonConfig);

                btnStart.mediaCapturedCallback = function() {
                    var options = {
                        type: type,
                        mimeType: mimeType,
                        disableLogs: params.disableLogs || false,
                        getNativeBlob: false, // enable it for longer recordings
                        video: recordingPlayer
                    };

                    if (recorderType) {
                        options.recorderType = recorderType;

                        if (recorderType == WhammyRecorder || recorderType == GifRecorder || recorderType == WebAssemblyRecorder) {
                            options.canvas = options.video = {
                                width: defaultWidth || 320,
                                height: defaultHeight || 240
                            };
                        }
                    }

                    if (videoBitsPerSecond) {
                        options.videoBitsPerSecond = videoBitsPerSecond;
                    }

                    options.ignoreMutedMedia = false;
                    btnStart.recordRTC = RecordRTC(btnStart.stream, options);

                    btnStart.recordingEndedCallback = function(url) {
                        setVideoURL(url);
                    };

                    btnStart.recordRTC.startRecording();
                    btnPause.style.display = '';
                };
            }

            // note: audio+tab is supported in Chrome 50+
            // todo: add audio+tab recording
            if (recordingMedia.value === 'with-sound') {
                captureAudioPlusScreen(commonConfig);

                btnStart.mediaCapturedCallback = function() {
                    var options = {
                        type: type,
                        mimeType: mimeType,
                        disableLogs: params.disableLogs || false,
                        getNativeBlob: false, // enable it for longer recordings
                        video: recordingPlayer
                    };

                    if (recorderType) {
                        options.recorderType = recorderType;

                        if (recorderType == WhammyRecorder || recorderType == GifRecorder || recorderType == WebAssemblyRecorder) {
                            options.canvas = options.video = {
                                width: defaultWidth || 320,
                                height: defaultHeight || 240
                            };
                        }
                    }

                    if (videoBitsPerSecond) {
                        options.videoBitsPerSecond = videoBitsPerSecond;
                    }

                    options.ignoreMutedMedia = false;
                    btnStart.recordRTC = RecordRTC(btnStart.stream, options);

                    btnStart.recordingEndedCallback = function(url) {
                        setVideoURL(url);
                    };

                    btnStart.recordRTC.startRecording();
                    btnPause.style.display = '';
                };
            }
        };

        function captureVideo(config) {
            captureUserMedia({video: true}, function(videoStream) {
                config.onMediaCaptured(videoStream);

                addStreamStopListener(videoStream, function() {
                    config.onMediaStopped();
                });
            }, function(error) {
                config.onMediaCapturingFailed(error);
            });
        }

        function captureAudioPlusVideo(config) {
            captureUserMedia({video: true, audio: true}, function(audioVideoStream) {
                config.onMediaCaptured(audioVideoStream);

                if (audioVideoStream instanceof Array) {
                    audioVideoStream.forEach(function(stream) {
                        addStreamStopListener(stream, function() {
                            config.onMediaStopped();
                        });
                    });
                    return;
                }

                addStreamStopListener(audioVideoStream, function() {
                    config.onMediaStopped();
                });
            }, function(error) {
                config.onMediaCapturingFailed(error);
            });
        }

        var MY_DOMAIN = 'webrtc-experiment.com';

        function isMyOwnDomain() {
            // replace "webrtc-experiment.com" with your own domain name
            return document.domain.indexOf(MY_DOMAIN) !== -1;
        }

        function isLocalHost() {
            // "chrome.exe" --enable-usermedia-screen-capturing
            // or firefox => about:config => "media.getusermedia.screensharing.allowed_domains" => add "localhost"
            return document.domain === 'localhost' || document.domain === '127.0.0.1';
        }

        var videoBitsPerSecond;

        function setVideoBitrates() {
            var select = document.querySelector('.media-bitrates');
            var value = select.value;

            if (value == 'default') {
                videoBitsPerSecond = null;
                return;
            }

            videoBitsPerSecond = parseInt(value);
        }

        function getFrameRates(mediaConstraints) {
            if (!mediaConstraints.video) {
                return mediaConstraints;
            }

            var select = document.querySelector('.media-framerates');
            var value = select.value;

            if (value == 'default') {
                return mediaConstraints;
            }

            value = parseInt(value);

            if (DetectRTC.browser.name === 'Firefox') {
                mediaConstraints.video.frameRate = value;
                return mediaConstraints;
            }

            if (!mediaConstraints.video.mandatory) {
                mediaConstraints.video.mandatory = {};
                mediaConstraints.video.optional = [];
            }

            var isScreen = recordingMedia.value.toString().toLowerCase().indexOf('screen') != -1;
            if (isScreen) {
                mediaConstraints.video.mandatory.maxFrameRate = value;
            }
            else {
                mediaConstraints.video.mandatory.minFrameRate = value;
            }

            return mediaConstraints;
        }

        function setGetFromLocalStorage(selectors) {
            selectors.forEach(function(selector) {
                var storageItem = selector.replace(/\.|#/g, '');
                if (localStorage.getItem(storageItem)) {
                    document.querySelector(selector).value = localStorage.getItem(storageItem);
                }

                addEventListenerToUploadLocalStorageItem(selector, ['change', 'blur'], function() {
                    localStorage.setItem(storageItem, document.querySelector(selector).value);
                });
            });
        }

        function addEventListenerToUploadLocalStorageItem(selector, arr, callback) {
            arr.forEach(function(event) {
                document.querySelector(selector).addEventListener(event, callback, false);
            });
        }

        setGetFromLocalStorage(['.media-resolutions', '.media-framerates', '.media-bitrates', '.recording-media', '.media-container-format']);

        function getVideoResolutions(mediaConstraints) {
            if (!mediaConstraints.video) {
                return mediaConstraints;
            }

            var select = document.querySelector('.media-resolutions');
            var value = select.value;

            if (value == 'default') {
                return mediaConstraints;
            }

            value = value.split('x');

            if (value.length != 2) {
                return mediaConstraints;
            }

            defaultWidth = parseInt(value[0]);
            defaultHeight = parseInt(value[1]);

            if (DetectRTC.browser.name === 'Firefox') {
                mediaConstraints.video.width = defaultWidth;
                mediaConstraints.video.height = defaultHeight;
                return mediaConstraints;
            }

            if (!mediaConstraints.video.mandatory) {
                mediaConstraints.video.mandatory = {};
                mediaConstraints.video.optional = [];
            }

            var isScreen = recordingMedia.value.toString().toLowerCase().indexOf('screen') != -1;

            if (isScreen) {
                mediaConstraints.video.mandatory.maxWidth = defaultWidth;
                mediaConstraints.video.mandatory.maxHeight = defaultHeight;
            }
            else {
                mediaConstraints.video.mandatory.minWidth = defaultWidth;
                mediaConstraints.video.mandatory.minHeight = defaultHeight;
            }

            return mediaConstraints;
        }

        function captureUserMedia(mediaConstraints, successCallback, errorCallback) {
            if (mediaConstraints.video == true) {
                mediaConstraints.video = {};
            }

            setVideoBitrates();

            mediaConstraints = getVideoResolutions(mediaConstraints);
            mediaConstraints = getFrameRates(mediaConstraints);

            var isBlackBerry = !!(/BB10|BlackBerry/i.test(navigator.userAgent || ''));
            if (isBlackBerry && !!(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia)) {
                navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                navigator.getUserMedia(mediaConstraints, successCallback, errorCallback);
                return;
            }

            navigator.mediaDevices.getUserMedia(mediaConstraints).then(function(stream) {
                successCallback(stream);

                setVideoURL(stream, true);
            }).catch(function(error) {
                if (error && (error.name === 'ConstraintNotSatisfiedError' || error.name === 'OverconstrainedError')) {
                    alert('Your camera or browser does NOT supports selected resolutions or frame-rates. \n\nPlease select "default" resolutions.');
                }
                else if (error && error.message) {
                    alert(error.message);
                }
                else {
                    alert('Unable to make getUserMedia request. Please check browser console logs.');
                }

                errorCallback(error);
            });
        }

        function setMediaContainerFormat(arrayOfOptionsSupported) {
            var options = Array.prototype.slice.call(
                mediaContainerFormat.querySelectorAll('option')
            );

            var localStorageItem;
            if (localStorage.getItem('media-container-format')) {
                localStorageItem = localStorage.getItem('media-container-format');
            }

            var selectedItem;
            options.forEach(function(option) {
                option.disabled = true;

                if (arrayOfOptionsSupported.indexOf(option.value) !== -1) {
                    option.disabled = false;

                    if (localStorageItem && arrayOfOptionsSupported.indexOf(localStorageItem) != -1) {
                        if (option.value != localStorageItem) return;
                        option.selected = true;
                        selectedItem = option;
                        return;
                    }

                    if (!selectedItem) {
                        option.selected = true;
                        selectedItem = option;
                    }
                }
            });
        }

        function isMimeTypeSupported(mimeType) {
            if (typeof MediaRecorder === 'undefined') {
                return false;
            }

            if (typeof MediaRecorder.isTypeSupported !== 'function') {
                return true;
            }

            return MediaRecorder.isTypeSupported(mimeType);
        }

        recordingMedia.onchange = function() {
            var isChrome = !!window.chrome && !(!!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0);

            var recordingOptions = ['vp8']; // MediaStreamRecorder with vp8

            if (isMimeTypeSupported('video/webm\;codecs=vp9')) {
                recordingOptions.push('vp9'); // MediaStreamRecorder with vp9
            }

            if (isMimeTypeSupported('video/webm\;codecs=h264')) {
                recordingOptions.push('h264'); // MediaStreamRecorder with h264
            }

            if (isMimeTypeSupported('video/x-matroska;codecs=avc1')) {
                recordingOptions.push('mkv'); // MediaStreamRecorder with mkv/matroska
            }

            recordingOptions.push('gif'); // GifRecorder

            if (DetectRTC.browser.name == 'Chrome') {
                recordingOptions.push('whammy'); // WhammyRecorder
            }

            if (DetectRTC.browser.name == 'Chrome') {
                recordingOptions.push('WebAssembly'); // WebAssemblyRecorder
            }

            recordingOptions.push('default'); // Default mimeType for MediaStreamRecorder

            setMediaContainerFormat(recordingOptions);
        };
        recordingMedia.onchange();

        if (typeof MediaRecorder === 'undefined' && (DetectRTC.browser.name === 'Edge' || DetectRTC.browser.name === 'Safari')) {
            // webp isn't supported in Microsoft Edge
            // neither MediaRecorder API
            // so lets disable both video/screen recording options

            console.warn('Neither MediaRecorder API nor webp is supported in ' + DetectRTC.browser.name + '. You cam merely record audio.');

            recordingMedia.innerHTML = '<option value="with-sound">With Sound</option>';
            setMediaContainerFormat(['pcm']);
        }

        function stringify(obj) {
            var result = '';
            Object.keys(obj).forEach(function(key) {
                if (typeof obj[key] === 'function') {
                    return;
                }

                if (result.length) {
                    result += ',';
                }

                result += key + ': ' + obj[key];
            });

            return result;
        }

        function mediaRecorderToStringify(mediaRecorder) {
            var result = '';
            result += 'mimeType: ' + mediaRecorder.mimeType;
            result += ', state: ' + mediaRecorder.state;
            result += ', audioBitsPerSecond: ' + mediaRecorder.audioBitsPerSecond;
            result += ', videoBitsPerSecond: ' + mediaRecorder.videoBitsPerSecond;
            if (mediaRecorder.stream) {
                result += ', streamid: ' + mediaRecorder.stream.id;
                result += ', stream-active: ' + mediaRecorder.stream.active;
            }
            return result;
        }

        function getFailureReport() {
            var info = 'RecordRTC seems failed. \n\n' + stringify(DetectRTC.browser) + '\n\n' + DetectRTC.osName + ' ' + DetectRTC.osVersion + '\n';

            if (typeof recorderType !== 'undefined' && recorderType) {
                info += '\nrecorderType: ' + recorderType.name;
            }

            if (typeof mimeType !== 'undefined') {
                info += '\nmimeType: ' + mimeType;
            }

            Array.prototype.slice.call(document.querySelectorAll('select')).forEach(function(select) {
                info += '\n' + (select.id || select.className) + ': ' + select.value;
            });

            if (btnStart.recordRTC) {
                info += '\n\ninternal-recorder: ' + btnStart.recordRTC.getInternalRecorder().name;
                
                if (btnStart.recordRTC.getInternalRecorder().getAllStates) {
                    info += '\n\nrecorder-states: ' + btnStart.recordRTC.getInternalRecorder().getAllStates();
                }
            }

            if (btnStart.stream) {
                info += '\n\naudio-tracks: ' + getTracks(btnStart.stream, 'audio').length;
                info += '\nvideo-tracks: ' + getTracks(btnStart.stream, 'video').length;
                info += '\nstream-active? ' + !!btnStart.stream.active;

                btnStart.stream.getTracks().forEach(function(track) {
                    info += '\n' + track.kind + '-track-' + (track.label || track.id) + ': (enabled: ' + !!track.enabled + ', readyState: ' + track.readyState + ', muted: ' + !!track.muted + ')';

                    if (track.getConstraints && Object.keys(track.getConstraints()).length) {
                        info += '\n' + track.kind + '-track-getConstraints: ' + stringify(track.getConstraints());
                    }

                    if (track.getSettings && Object.keys(track.getSettings()).length) {
                        info += '\n' + track.kind + '-track-getSettings: ' + stringify(track.getSettings());
                    }
                });
            }

            if (timeSlice && btnStart.recordRTC) {
                info += '\ntimeSlice: ' + timeSlice;

                if (btnStart.recordRTC.getInternalRecorder().getArrayOfBlobs) {
                    var blobSizes = [];
                    btnStart.recordRTC.getInternalRecorder().getArrayOfBlobs().forEach(function(blob) {
                        blobSizes.push(blob.size);
                    });
                    info += '\nblobSizes: ' + blobSizes;
                }
            }

            else if (btnStart.recordRTC && btnStart.recordRTC.getBlob()) {
                info += '\n\nblobSize: ' + bytesToSize(btnStart.recordRTC.getBlob().size);
            }

            if (btnStart.recordRTC && btnStart.recordRTC.getInternalRecorder() && btnStart.recordRTC.getInternalRecorder().getInternalRecorder && btnStart.recordRTC.getInternalRecorder().getInternalRecorder()) {
                info += '\n\ngetInternalRecorder: ' + mediaRecorderToStringify(btnStart.recordRTC.getInternalRecorder().getInternalRecorder());
            }

            return info;
        }

        function saveToDiskOrOpenNewTab(recordRTC) {
            if (!recordRTC.getBlob().size) {
                var info = getFailureReport();
                console.log('blob', recordRTC.getBlob());
                console.log('recordrtc instance', recordRTC);
                console.log('report', info);

                if (mediaContainerFormat.value !== 'default') {
                    alert('RecordRTC seems failed recording using ' + mediaContainerFormat.value + '. Please choose "default" option from the drop down and record again.');
                }
                else {
                    alert('RecordRTC seems failed. Unexpected issue. You can read the email in your console log. \n\nPlease report using disqus chat below.');
                }

                if (mediaContainerFormat.value !== 'vp9' && DetectRTC.browser.name === 'Chrome') {
                    alert('Please record using VP9 encoder. (select from the dropdown)');
                }
            }

            var fileName = getFileName(fileExtension);

            document.querySelector('#save-to-disk').parentNode.style.display = 'block';
            document.querySelector('#save-to-disk').onclick = function() {
                if (!recordRTC) return alert('No recording found.');

                var file = new File([recordRTC.getBlob()], fileName, {
                    type: mimeType
                });

                invokeSaveAsDialog(file, file.name);
            };

            // upload to PHP server
            if (isMyOwnDomain()) {
                document.querySelector('#upload-to-php').disabled = true;
                document.querySelector('#upload-to-php').style.display = 'none';
            }
            else {
                document.querySelector('#upload-to-php').disabled = false;
            }
            
            document.querySelector('#upload-to-php').onclick = function() {
                if (isMyOwnDomain()) {
                    alert('PHP Upload is not available on this domain.');
                    return;
                }

                if (!recordRTC) return alert('No recording found.');
                this.disabled = true;

                var button = this;
                uploadToPHPServer(fileName, recordRTC, function(progress, fileURL) {
                    if (progress === 'ended') {
                        button.disabled = false;
                        button.innerHTML = 'Click to download from server';
                        button.onclick = function() {
                            SaveFileURLToDisk(fileURL, fileName);
                        };

                        setVideoURL(fileURL);

                        var html = 'Uploaded to PHP.<br>Download using below link:<br>';
                        html += '<a href="'+fileURL+'" download="'+fileName+'" style="color: yellow; display: block; margin-top: 15px;">'+fileName+'</a>';
                        recordingPlayer.parentNode.parentNode.querySelector('h2').innerHTML = html;
                        return;
                    }
                    button.innerHTML = progress;
                    recordingPlayer.parentNode.parentNode.querySelector('h2').innerHTML = progress;
                });
            };
        }

        function uploadToPHPServer(fileName, recordRTC, callback) {
            var blob = recordRTC instanceof Blob ? recordRTC : recordRTC.getBlob();
            
            blob = new File([blob], getFileName(fileExtension), {
                type: mimeType
            });

            // create FormData
            var formData = new FormData();
            formData.append('video-filename', fileName);
            formData.append('video-blob', blob);

            callback('Uploading recorded-file to server.');

            // var upload_url = 'https://your-domain.com/files-uploader/';
            var upload_url = 'RecordRTC-to-PHP/save.php';

            // var upload_directory = upload_url;
            var upload_directory = 'RecordRTC-to-PHP/uploads/';

            makeXMLHttpRequest(upload_url, formData, function(progress) {
                if (progress !== 'upload-ended') {
                    callback(progress);
                    return;
                }

                callback('ended', upload_directory + fileName);
            });
        }

        function makeXMLHttpRequest(url, data, callback) {
            var request = new XMLHttpRequest();
            request.onreadystatechange = function() {
                if (request.readyState == 4 && request.status == 200) {
                    if (request.responseText === 'success') {
                        callback('upload-ended');
                        return;
                    }

                    document.querySelector('.header').parentNode.style = 'text-align: left; color: red; padding: 5px 10px;';
                    document.querySelector('.header').parentNode.innerHTML = request.responseText;
                }
            };

            request.upload.onloadstart = function() {
                callback('Upload started...');
            };

            request.upload.onprogress = function(event) {
                callback('Upload Progress ' + Math.round(event.loaded / event.total * 100) + "%");
            };

            request.upload.onload = function() {
                callback('progress-about-to-end');
            };

            request.upload.onload = function() {
                callback('Getting File URL..');
            };

            request.upload.onerror = function(error) {
                callback('Failed to upload to server');
            };

            request.upload.onabort = function(error) {
                callback('Upload aborted.');
            };

            request.open('POST', url);
            request.send(data);
        }

        function getRandomString() {
            if (window.crypto && window.crypto.getRandomValues && navigator.userAgent.indexOf('Safari') === -1) {
                var a = window.crypto.getRandomValues(new Uint32Array(3)),
                    token = '';
                for (var i = 0, l = a.length; i < l; i++) {
                    token += a[i].toString(36);
                }
                return token;
            } else {
                return (Math.random() * new Date().getTime()).toString(36).replace(/\./g, '');
            }
        }

        function getFileName(fileExtension) {
            var d = new Date();
            var year = d.getUTCFullYear();
            var month = d.getUTCMonth();
            var date = d.getUTCDate();
            return 'RecordRTC-' + year + month + date + '-' + getRandomString() + '.' + fileExtension;
        }

        function SaveFileURLToDisk(fileUrl, fileName) {
            var hyperlink = document.createElement('a');
            hyperlink.href = fileUrl;
            hyperlink.target = '_blank';
            hyperlink.download = fileName || fileUrl;

            (document.body || document.documentElement).appendChild(hyperlink);
            hyperlink.onclick = function() {
                (document.body || document.documentElement).removeChild(hyperlink);

                // required for Firefox
                window.URL.revokeObjectURL(hyperlink.href);
            };

            var mouseEvent = new MouseEvent('click', {
                view: window,
                bubbles: true,
                cancelable: true
            });

            hyperlink.dispatchEvent(mouseEvent);
        }

        function getURL(arg) {
            var url = arg;

            if (arg instanceof Blob || arg instanceof File) {
                url = URL.createObjectURL(arg);
            }

            if (arg instanceof RecordRTC || arg.getBlob) {
                url = URL.createObjectURL(arg.getBlob());
            }

            if (arg instanceof MediaStream || arg.getTracks) {
                // url = URL.createObjectURL(arg);
            }

            return url;
        }

        function setVideoURL(arg, forceNonImage) {
            var url = getURL(arg);

            var parentNode = recordingPlayer.parentNode;
            parentNode.removeChild(recordingPlayer);
            parentNode.innerHTML = '';

            var elem = 'video';
            if (type == 'gif' && !forceNonImage) {
                elem = 'img';
            }
            if (type == 'audio') {
                elem = 'audio';
            }

            recordingPlayer = document.createElement(elem);
            
            if (arg instanceof MediaStream) {
                recordingPlayer.muted = true;
            }

            recordingPlayer.addEventListener('loadedmetadata', function() {
                if (navigator.userAgent.toLowerCase().indexOf('android') == -1) return;

                // android
                setTimeout(function() {
                    if (typeof recordingPlayer.play === 'function') {
                        recordingPlayer.play();
                    }
                }, 2000);
            }, false);

            recordingPlayer.poster = '';

            if (arg instanceof MediaStream) {
                recordingPlayer.srcObject = arg;
            }
            else {
                recordingPlayer.src = url;
            }

            if (typeof recordingPlayer.play === 'function') {
                recordingPlayer.play();
            }

            recordingPlayer.addEventListener('ended', function() {
                url = getURL(arg);
                
                if (arg instanceof MediaStream) {
                    recordingPlayer.srcObject = arg;
                }
                else {
                    recordingPlayer.src = url;
                }
            });

            parentNode.appendChild(recordingPlayer);
        }
    </script>

    <script>
        function captureScreen(config) {
            if (navigator.getDisplayMedia) {
                navigator.getDisplayMedia({
                    video: true
                }).then(screenStream => {
                    config.onMediaCaptured(screenStream);

                    addStreamStopListener(screenStream, function() {
                        // config.onMediaStopped();

                        btnStart.onclick();
                    });

                    setVideoURL(screenStream, true);
                }).catch(function(error) {
                    config.onMediaCapturingFailed(error);
                });
            } else if (navigator.mediaDevices.getDisplayMedia) {
                navigator.mediaDevices.getDisplayMedia({
                    video: true
                }).then(screenStream => {
                    config.onMediaCaptured(screenStream);

                    addStreamStopListener(screenStream, function() {
                        // config.onMediaStopped();

                        btnStart.onclick();
                    });

                    setVideoURL(screenStream, true);
                }).catch(function(error) {
                    config.onMediaCapturingFailed(error);
                });
            } else {
                var error = 'getDisplayMedia API are not supported in this browser.';
                config.onMediaCapturingFailed(error);
                alert(error);
            }
        }

        function captureAudioPlusScreen(config) {
            if (navigator.getDisplayMedia) {
                navigator.getDisplayMedia({
                    video: true
                }).then(screenStream => {
                    navigator.mediaDevices.getUserMedia({audio:true}).then(function(mic) {
                        screenStream.addTrack(mic.getTracks()[0]);

                        config.onMediaCaptured(screenStream);

                        addStreamStopListener(screenStream, function() {
                            // config.onMediaStopped();

                            btnStart.onclick();
                        });

                        setVideoURL(screenStream, true);
                    });
                }).catch(function(error) {
                    config.onMediaCapturingFailed(error);
                });
            } else if (navigator.mediaDevices.getDisplayMedia) {
                navigator.mediaDevices.getDisplayMedia({
                    video: true
                }).then(screenStream => {
                    navigator.mediaDevices.getUserMedia({audio:true}).then(function(mic) {
                        screenStream.addTrack(mic.getTracks()[0]);

                        config.onMediaCaptured(screenStream);

                        addStreamStopListener(screenStream, function() {
                            // config.onMediaStopped();

                            btnStart.onclick();
                        });

                        setVideoURL(screenStream, true);
                    });
                }).catch(function(error) {
                    config.onMediaCapturingFailed(error);
                });
            } else {
                var error = 'getDisplayMedia API are not supported in this browser.';
                config.onMediaCapturingFailed(error);
                alert(error);
            }
        }
    </script>

    <script>
        /* cors_upload.js Copyright 2015 Google Inc. All Rights Reserved. */

        var DRIVE_UPLOAD_URL = 'https://www.googleapis.com/upload/drive/v2/files/';

        var RetryHandler = function() {
            this.interval = 1000; // Start at one second
            this.maxInterval = 60 * 1000; // Don't wait longer than a minute 
        };

        RetryHandler.prototype.retry = function(fn) {
            setTimeout(fn, this.interval);
            this.interval = this.nextInterval_();
        };

        RetryHandler.prototype.reset = function() {
            this.interval = 1000;
        };

        RetryHandler.prototype.nextInterval_ = function() {
            var interval = this.interval * 2 + this.getRandomInt_(0, 1000);
            return Math.min(interval, this.maxInterval);
        };

        RetryHandler.prototype.getRandomInt_ = function(min, max) {
            return Math.floor(Math.random() * (max - min + 1) + min);
        };

        var MediaUploader = function(options) {
            var noop = function() {};
            this.file = options.file;
            this.contentType = options.contentType || this.file.type || 'application/octet-stream';
            this.metadata = options.metadata || {
            'title': this.file.name,
            'mimeType': this.contentType
            };
            this.token = options.token;
            this.onComplete = options.onComplete || noop;
            this.onProgress = options.onProgress || noop;
            this.onError = options.onError || noop;
            this.offset = options.offset || 0;
            this.chunkSize = options.chunkSize || 0;
            this.retryHandler = new RetryHandler();

            this.url = options.url;
            if (!this.url) {
            var params = options.params || {};
            params.uploadType = 'resumable';
            this.url = this.buildUrl_(options.fileId, params, options.baseUrl);
            }
            this.httpMethod = options.fileId ? 'PUT' : 'POST';
        };

        MediaUploader.prototype.upload = function() {
            var self = this;
            var xhr = new XMLHttpRequest();

            xhr.open(this.httpMethod, this.url, true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + this.token);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('X-Upload-Content-Length', this.file.size);
            xhr.setRequestHeader('X-Upload-Content-Type', this.contentType);

            xhr.onload = function(e) {
            if (e.target.status < 400) {
                var location = e.target.getResponseHeader('Location');
                this.url = location;
                this.sendFile_();
            } else {
                this.onUploadError_(e);
            }
            }.bind(this);
            xhr.onerror = this.onUploadError_.bind(this);
            xhr.send(JSON.stringify(this.metadata));
        };

        MediaUploader.prototype.sendFile_ = function() {
            var content = this.file;
            var end = this.file.size;

            if (this.offset || this.chunkSize) {
            // Only bother to slice the file if we're either resuming or uploading in chunks
            if (this.chunkSize) {
                end = Math.min(this.offset + this.chunkSize, this.file.size);
            }
            content = content.slice(this.offset, end);
            }

            var xhr = new XMLHttpRequest();
            xhr.open('PUT', this.url, true);
            xhr.setRequestHeader('Content-Type', this.contentType);
            xhr.setRequestHeader('Content-Range', 'bytes ' + this.offset + '-' + (end - 1) + '/' + this.file.size);
            xhr.setRequestHeader('X-Upload-Content-Type', this.file.type);
            if (xhr.upload) {
            xhr.upload.addEventListener('progress', this.onProgress);
            }
            xhr.onload = this.onContentUploadSuccess_.bind(this);
            xhr.onerror = this.onContentUploadError_.bind(this);
            xhr.send(content);
        };

        MediaUploader.prototype.resume_ = function() {
            var xhr = new XMLHttpRequest();
            xhr.open('PUT', this.url, true);
            xhr.setRequestHeader('Content-Range', 'bytes */' + this.file.size);
            xhr.setRequestHeader('X-Upload-Content-Type', this.file.type);
            if (xhr.upload) {
            xhr.upload.addEventListener('progress', this.onProgress);
            }
            xhr.onload = this.onContentUploadSuccess_.bind(this);
            xhr.onerror = this.onContentUploadError_.bind(this);
            xhr.send();
        };

        MediaUploader.prototype.extractRange_ = function(xhr) {
            var range = xhr.getResponseHeader('Range');
            if (range) {
            this.offset = parseInt(range.match(/\d+/g).pop(), 10) + 1;
            }
        };

        MediaUploader.prototype.onContentUploadSuccess_ = function(e) {
            if (e.target.status == 200 || e.target.status == 201) {
            this.onComplete(e.target.response);
            } else if (e.target.status == 308) {
            this.extractRange_(e.target);
            this.retryHandler.reset();
            this.sendFile_();
            }
        };

        MediaUploader.prototype.onContentUploadError_ = function(e) {
            if (e.target.status && e.target.status < 500) {
            this.onError(e.target.response);
            } else {
            this.retryHandler.retry(this.resume_.bind(this));
            }
        };

        MediaUploader.prototype.onUploadError_ = function(e) {
            this.onError(e.target.response); // TODO - Retries for initial upload
        };

        MediaUploader.prototype.buildQuery_ = function(params) {
            params = params || {};
            return Object.keys(params).map(function(key) {
            return encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
            }).join('&');
        };

        MediaUploader.prototype.buildUrl_ = function(id, params, baseUrl) {
            var url = baseUrl || DRIVE_UPLOAD_URL;
            if (id) {
            url += id;
            }
            var query = this.buildQuery_(params);
            if (query) {
            url += '?' + query;
            }
            return url;
        };
    </script>

    <script>
        var btnPause = document.querySelector('#btn-pause-recording');
        btnPause.onclick = function() {
            if (!btnStart.recordRTC) {
                btnPause.style.display = 'none';
                return;
            }

            btnPause.disabled = true;
            if (btnPause.innerHTML === 'Pause') {
                btnStart.disabled = true;
                btnStart.style.fontSize = '15px';
                btnStart.recordRTC.pauseRecording();
                recordingPlayer.parentNode.parentNode.querySelector('h2').innerHTML = 'Recording status: paused';
                recordingPlayer.pause();

                btnPause.style.fontSize = 'inherit';
                setTimeout(function() {
                    btnPause.innerHTML = 'Resume Recording';
                    btnPause.disabled = false;
                }, 2000);
            }

            if (btnPause.innerHTML === 'Resume Recording') {
                btnStart.disabled = false;
                btnStart.style.fontSize = 'inherit';
                btnStart.recordRTC.resumeRecording();
                recordingPlayer.parentNode.parentNode.querySelector('h2').innerHTML = '<img src="https://www.webrtc-experiment.com/images/progress.gif">';
                recordingPlayer.play();

                btnPause.style.fontSize = '15px';
                btnPause.innerHTML = 'Pause';
                setTimeout(function() {
                    btnPause.disabled = false;
                }, 2000);
            }
        };
    </script>
</body>
</html>
